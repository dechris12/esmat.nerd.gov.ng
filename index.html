<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NERD Compliance Verification</title>
    <style>
        body { font-family: "Times New Roman", serif; background-color: #fff; color: #000; margin: 0; padding: 20px; display: flex; justify-content: center; }
        #app { max-width: 800px; width: 100%; }
        
        .header { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .ndn { font-size: 15px; margin-bottom: 10px; margin-top: 15px; } /* Added margin-top for space */
        hr { border: 0; border-top: 1px solid #ccc; margin: 10px 0; }
        
        .details p { margin: 2px 0; font-size: 15px; line-height: 1.2; }
        .details strong { font-weight: bold; }
        
        /* Compliance Section */
        .compliance { margin-top: 20px; }
        .compliance-label { 
            font-size: 10px; 
            font-weight: bold; 
            display: block; 
            margin-bottom: 15px; 
        }
        .compliance ul { 
            list-style: disc; 
            padding-left: 30px; 
            margin: 0;
        }
        .compliance li { font-size: 15px; margin-bottom: 2px; }
        /* Changed color to black */
        .status-badge { background-color: #2e7d32; color: #000; padding: 0px 4px; font-weight: normal; }

        /* Documents Section */
        .docs { margin-top: 20px; }
        .docs-title { font-weight: bold; font-size: 16px; margin-bottom: 5px; color: #000; }
        .docs ul { list-style: disc; padding-left: 30px; margin: 0; }
        .docs li { margin-bottom: 0px; line-height: 1.1; } 
        .docs a { color: #0000EE; text-decoration: underline; font-size: 15px; }

        .error { text-align: center; margin-top: 50px; font-family: Arial, sans-serif; }
        .loading { text-align: center; color: #999; margin-top: 50px; }
    </style>
</head>
<body>

<div id="app">
    <div id="content" class="loading">Searching record...</div>
</div>

<script>
    const SHEET_ID = '1RBpClxl8hIRW3Y0PJdClYRebtGlYu_yJE7IWGVU_7to'; 
    
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('id');

    // Helper for Title Case (Initials)
    function toTitleCase(str) {
        if (!str) return 'N/A';
        return str.toString().toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }

    // Helper to format Google Sheets Date string
    function formatDate(dateStr) {
        if (!dateStr || !dateStr.includes('Date')) return dateStr;
        const vals = dateStr.match(/\d+/g);
        if (!vals) return dateStr;
        // Month is 0-indexed in JS Date, but match raw values for display
        const y = vals[0];
        const m = (parseInt(vals[1]) + 1).toString().padStart(2, '0');
        const d = vals[2].padStart(2, '0');
        const hh = vals[3].padStart(2, '0');
        const mm = vals[4].padStart(2, '0');
        const ss = vals[5].padStart(2, '0');
        return `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
    }

    async function verifyUser() {
        const content = document.getElementById('content');

        if (!userId) {
            content.innerHTML = '<div class="error"><h2>❌ No ID Provided</h2><p>Please scan a valid QR code.</p></div>';
            return;
        }

        try {
            const response = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`);
            const text = await response.text();
            const json = JSON.parse(text.substring(47).slice(0, -2));
            const rows = json.table.rows;

            const match = rows.find(r => r.c[0]?.v == userId);

            if (match) {
                // Formatting data according to requirements
                const title = (match.c[1]?.v || 'N/A').toUpperCase(); // Bold & Caps via HTML/JS
                const studentName = toTitleCase(match.c[2]?.v);
                const institution = toTitleCase(match.c[3]?.v);
                const faculty = toTitleCase(match.c[4]?.v);
                const department = toTitleCase(match.c[5]?.v);
                const submissionType = toTitleCase(match.c[6]?.v);
                const formattedDate = formatDate(match.c[7]?.f || match.c[7]?.v || 'N/A');

                content.innerHTML = `
                    <div class="header">NERD Compliance Verification</div>
                    <div class="ndn"><strong>NDN:</strong> ${userId}</div>
                    <hr>
                    <div class="details">
                        <p><strong>Title:</strong> <strong>${title}</strong></p>
                        <p><strong>Student name:</strong> ${studentName}</p>
                        <p><strong>Institution:</strong> ${institution}</p>
                        <p><strong>Faculty:</strong> ${faculty}</p>
                        <p><strong>Department:</strong> ${department}</p>
                        <p><strong>Submission Type:</strong> ${submissionType}</p>
                        <p><strong>Date of Submission:</strong> ${formattedDate}</p>
                    </div>
                    
                    <div class="compliance">
                        <span class="compliance-label">Compliance</span>
                        <ul>
                            <li>NCVS Compliance: <i>Not enforced</i></li>
                            <li>Academic report submission: <span class="status-badge">Complied</span></li>
                        </ul>
                    </div>

                    <div class="docs">
                        <div class="docs-title">Documents:</div>
                        <ul>
                            <li><a href="#">Original Upload</a></li>
                            <li><a href="#">System Generated PDF</a></li>
                        </ul>
                    </div>
                `;
                content.className = ""; 
            } else {
                content.innerHTML = `<div class="error"><h2>❌ Verification Failed</h2><p>Record ${userId} not found in our database.</p></div>`;
            }
        } catch (e) {
            content.innerHTML = '<div class="error"><h2>⚠️ Connection Error</h2><p>Could not reach the database.</p></div>';
        }
    }

    verifyUser();
</script>

</body>
</html>
